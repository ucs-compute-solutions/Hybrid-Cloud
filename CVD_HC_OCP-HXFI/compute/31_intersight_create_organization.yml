---

- name: Define anchor for Intersight API login info 
  set_fact:
    intersight_api_login_info: &intersight_api_login_info
      api_private_key:         "{{ intersight_api_private_key }}"
      api_key_id:              "{{ intersight_api_key_id }}"
      api_uri:                 "{{ intersight_api_uri | default(omit) }}"
      validate_certs:          "{{ intersight_validate_certs | default(omit) }}"
      #state:                  "{{ intersight_state | default(omit) }}"

- debug:
    msg: "API Info is: {{ intersight_api_login_info }}"
  tags: [never, debug]

- name: Create Intersight Organization and return Moid  
  intersight_rest_api:
    <<: *intersight_api_login_info
    resource_path: /organization/Organizations
    query_params:
      $filter: "Name eq '{{ organization_name }}'"
    api_body: {
      "Name":           "{{ organization_name }}", 
      "Description":    "{{ organization_description }}",
      "ResourceGroups": [
        {
          "Moid":       "{{ resource_group_moid }}"
        }
      ]
    }
    state: present
  register: organization_response
  delegate_to: local_host
  tags: 
    - organization
    #- never

- name: Query for an existing Organization and return Moid 
  intersight_rest_api:
    <<: *intersight_api_login_info
    resource_path: /organization/Organizations
    query_params:
      $filter: "Name eq '{{ organization_name }}'"
  register: organization_response
  delegate_to: local_host
  tags: 
    - organization
    - never

- name: Moid for Organization
  set_fact:
    organization_moid: "{{ organization_response.api_response.Moid }}"

- debug:
    msg: "Created Organization '{{ organization_name }}' with Moid: '{{ organization_moid }}'"  
  #tags: [never, debug]